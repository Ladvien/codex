[databases]
# Database connection configuration
# Format: dbname = host=hostname port=port dbname=database user=username password=password
codex_memory = host=localhost port=5432 dbname=codex_memory user=postgres password=postgres
codex_memory_test = host=localhost port=5432 dbname=codex_memory_test user=postgres password=postgres

# Fallback database for authentication
* = host=localhost port=5432

[pgbouncer]
# NETWORK CONFIGURATION
# Listen on all interfaces (adjust for production security)
listen_addr = 0.0.0.0
listen_port = 6432

# AUTHENTICATION
auth_type = trust
auth_file = /etc/pgbouncer/userlist.txt
auth_hba_file = /etc/pgbouncer/pg_hba.conf

# CONNECTION POOLING CONFIGURATION
# Pool mode: session, transaction, or statement
# - session: server is released back to pool when client disconnects
# - transaction: server is released back to pool when transaction finishes
# - statement: server is released back to pool when statement finishes
pool_mode = transaction

# CONNECTION LIMITS
# Support 2000 client connections as per HIGH-004 requirements
max_client_conn = 2000
default_pool_size = 100
min_pool_size = 20
reserve_pool_size = 20
reserve_pool_timeout = 3

# SERVER CONNECTION LIMITS
# These should match or be less than PostgreSQL's max_connections
max_db_connections = 180
max_user_connections = 150

# CONNECTION TIMEOUTS
# Optimized for high-throughput vector operations
server_connect_timeout = 15
server_login_retry = 15
query_timeout = 300
query_wait_timeout = 30
client_login_timeout = 60
autodb_idle_timeout = 3600
server_idle_timeout = 600
server_lifetime = 3600
client_idle_timeout = 600

# POOL CLEANUP
server_check_delay = 30
server_check_query = SELECT 1

# TCP CONFIGURATION
tcp_defer_accept = 1
tcp_socket_buffer = 16384
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 60
tcp_keepintvl = 30
tcp_user_timeout = 30000

# SECURITY
ignore_startup_parameters = extra_float_digits

# APPLICATION NAME
application_name_add_host = 1

# LOGGING
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# SYSLOG
syslog = 0
syslog_facility = daemon
syslog_ident = pgbouncer

# VERBOSE LOGGING (disable in production)
verbose = 0

# STATISTICS
stats_period = 60

# ADMIN INTERFACE
admin_users = postgres
stats_users = postgres

# PERFORMANCE OPTIMIZATION
# Disable DNS lookups for better performance
dns_max_ttl = 15
dns_nxdomain_ttl = 15
dns_zone_check_period = 0

# MEMORY LIMITS
# Limit memory usage per connection
pkt_buf = 4096
sbuf_loopcnt = 5
suspend_timeout = 10
tcp_defer_accept = 45

# CLIENT CERTIFICATE
# client_tls_sslmode = disable
# client_tls_protocols = secure
# client_tls_ciphers = fast
# client_tls_ca_file = 
# client_tls_cert_file = 
# client_tls_key_file = 
# client_tls_dheparams = auto

# SERVER TLS
# server_tls_sslmode = prefer
# server_tls_protocols = secure
# server_tls_ciphers = fast
# server_tls_ca_file = 
# server_tls_cert_file = 
# server_tls_key_file = 

# UNIX SOCKET
# unix_socket_dir = /var/run/postgresql
# unix_socket_mode = 0777
# unix_socket_group = 

# PROCESS SETTINGS
pidfile = /var/run/pgbouncer/pgbouncer.pid
user = pgbouncer

# LOG DESTINATION
logfile = /var/log/pgbouncer/pgbouncer.log

# CONFIGURATION INCLUDES
# %include /etc/pgbouncer/local.conf